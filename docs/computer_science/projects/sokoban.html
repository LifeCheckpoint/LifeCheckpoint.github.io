<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-computer_science/projects/sokoban/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">基于 LibGDX 的 Sokoban 开发总结 | Life_Checkpoint&#x27;s Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lifecheckpoint.github.io/docs/computer_science/projects/sokoban"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="基于 LibGDX 的 Sokoban 开发总结 | Life_Checkpoint&#x27;s Blog"><meta data-rh="true" name="description" content="我想了想，下次还是不要把期末作业当成大项目搞了"><meta data-rh="true" property="og:description" content="我想了想，下次还是不要把期末作业当成大项目搞了"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lifecheckpoint.github.io/docs/computer_science/projects/sokoban"><link data-rh="true" rel="alternate" href="https://lifecheckpoint.github.io/docs/computer_science/projects/sokoban" hreflang="en"><link data-rh="true" rel="alternate" href="https://lifecheckpoint.github.io/docs/computer_science/projects/sokoban" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Life_Checkpoint&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Life_Checkpoint&#39;s Blog Atom Feed">






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" crossorigin="anonymous">
<script src="/js/prism-mathematica.js" async></script><link rel="stylesheet" href="/assets/css/styles.3d3a3ce3.css">
<script src="/assets/js/runtime~main.7da889a4.js" defer="defer"></script>
<script src="/assets/js/main.5bd98ff2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Lchpt.blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">文档 / 文字的力量</a><a class="navbar__item navbar__link" href="/blog">Blog / 碎碎念</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/LifeCheckpoint" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">欢迎</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/acgn/fan">永远不止的彼岸微风</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/computer_science/projects/manimgeo/main">不可以做机械降神派</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/computer_science/projects/manimgeo/main">项目，也是很重要的！</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/computer_science/projects/manimgeo/main">manimgeo</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/computer_science/projects/sokoban">Sokoban 开发总结</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/computer_science/mathematica/mma-mind-graph">和你的Mathematica过新年去吧</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/computer_science/hpc/qimin-intro">暴力出奇迹</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/computer_science/ai/flash_attn">AI带我去异世界？</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/computer_science/algo/calu-tree">算法便是全景监狱</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/math/integrate/div-sq-sin">也许会喜欢数学</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">不可以做机械降神派</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">项目，也是很重要的！</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Sokoban 开发总结</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>基于 LibGDX 的 Sokoban 开发总结</h1></header>
<p>这是我的一个<strong>期末作业</strong>，要求开发一个<strong>推箱子</strong>游戏，并且实现一个给定的功能</p>
<p><strong>项目地址</strong> 👉 <a href="https://github.com/LifeCheckpoint/Sokoban" target="_blank" rel="noopener noreferrer">Sokoban</a></p>
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;margin:20px 0"><p style="font-size:20px;color:white;margin-top:10px"></p><p>项目最终的<strong>文件结构</strong></p><p></p><img src="/img/docs/sokoban/prj-struct.png" alt="par" style="max-width:100%;height:auto;border-radius:10px"></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="开发准备">开发准备<a href="#开发准备" class="hash-link" aria-label="Direct link to 开发准备" title="Direct link to 开发准备">​</a></h2>
<p>知道作业内容后立马就开始和 <code>ChatGPT</code> 讨论什么引擎最合适开发游戏...一番争论，最后选了 <code>LibGDX</code></p>
<p><code>ChatGPT</code> <strong>非常自信地告诉我：</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-为什么选择-libgdx">✅ 为什么选择 LibGDX？<a href="#-为什么选择-libgdx" class="hash-link" aria-label="Direct link to ✅ 为什么选择 LibGDX？" title="Direct link to ✅ 为什么选择 LibGDX？">​</a></h3>
<ol>
<li><strong>粒子系统</strong>  ：LibGDX 内置粒子引擎，并且提供了一个粒子编辑器，您可以直观地设计粒子效果并导入游戏中。例如，在箱子移动或撞击墙壁时生成粒子效果，增加游戏的视觉冲击力。</li>
<li><strong>动画和缓动支持</strong>：LibGDX 支持缓动库（如 Universal Tween Engine），可以为推箱子、移动、缩放、旋转等效果设置缓动过渡，使动画更加自然。比如，在推动箱子时增加一个轻微的缓动或弹性效果，提升体验。</li>
<li><strong>画面动效</strong>：LibGDX 的场景管理和摄像机控制功能让您可以实现画面摇晃、缩放等效果，适用于模拟冲击感和视觉反馈。例如，推箱子撞到墙壁时可以让摄像机产生轻微抖动，提升游戏的互动感。</li>
<li><strong>简单易用</strong>：LibGDX 提供的 API 非常易于上手，对于新手或小团队开发者友好。您可以在较短时间内掌握基本操作，同时框架支持跨平台，可以方便地在桌面和移动端上测试和发布。</li>
</ol>
<p>嗯，项目完成后，我也要<strong>吐槽</strong>的是</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-为什么别用-libgdx">❌ 为什么别用 LibGDX？<a href="#-为什么别用-libgdx" class="hash-link" aria-label="Direct link to ❌ 为什么别用 LibGDX？" title="Direct link to ❌ 为什么别用 LibGDX？">​</a></h3>
<ol>
<li><strong>老土没用过的粒子系统</strong>：全程没用过</li>
<li><strong>简单到有点简陋的动画</strong>：有动画，有缓动曲线，这点还可以，但是动画的稳定性...实在难以苟同（例如，两个位移动画同时执行，不能指望最终位移是矢量和；两个动画明明分开执行，却能意想不到地杂交到一起并产生前述效应）</li>
<li><strong>Bug 无数</strong>：也许是个人开发的原因吧，感觉 bug 无数...从查找了一堆网友答案才知道<strong>根本没有任何效果</strong>的“设置组件顺序” <code>setZIndex()</code>，到各种坐标管理的混乱（当然我的问题更严重一些233...）</li>
</ol>
<p>建议还是用 <code>Unity</code> or <code>Unreal</code> 来制作游戏</p>
<p><em>个人的新手体验角度，横看成岭侧成峰，人人眼中自不同</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="项目特色">项目“特色”<a href="#项目特色" class="hash-link" aria-label="Direct link to 项目“特色”" title="Direct link to 项目“特色”">​</a></h2>
<ol>
<li>基于主流游戏引擎 LibGDX 开发，移植性强，可维护性高</li>
<li>允许素材异步加载，支持启用 Mipmap MSAA 等显示优化</li>
<li>原创美术素材，附加素材源文件，实现大量自定义的 GUI 动画组件，界面美观整洁</li>
<li>GUI 代码采用 服务定位器 与 单例模式 的结合设计 ，通过 gameMain 分发全局控制句柄，简化开发，重用率高</li>
<li>核心功能基于 TestNG 进行了充分单元 / 覆盖率测试</li>
<li>通过 JNI 高效进行跨语言协作，并且保证游戏对特定平台 api 的兼容</li>
</ol>
<p>（發自我的Github）</p>
<p>如果逐条拆解的话，其实应该是这样的...</p>
<table><thead><tr><th>吹的</th><th>实际上</th></tr></thead><tbody><tr><td>✅移植性强</td><td>❌用了特定平台编译的文件框，只能在 Win 上跑</td></tr><tr><td>✅可维护性高</td><td>❌可维护性高 ≠ 有人维护</td></tr><tr><td>✅大量自定义动画组件</td><td>❌自带的 UI 组件 bug 一堆，自己造轮子</td></tr><tr><td>✅界面美观整洁</td><td>❌复杂的我也不会（）</td></tr><tr><td>✅服务定位器 + 单例 设计模式</td><td>❌做大了发现根本不好用，懒得重构了</td></tr><tr><td>✅简化开发</td><td>❌让开发更头秃</td></tr><tr><td>✅重用率高</td><td>❌指复制粘贴键的重用率高</td></tr><tr><td>✅充分单元测试</td><td>❌只测了几个核心逻辑功能，有的甚至没通过</td></tr><tr><td>✅JNI 高效跨语言协作</td><td>❌（见第一条）</td></tr></tbody></table>
<p>说不定这也算是开发常态（）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="美术有点难">美术有点难<a href="#美术有点难" class="hash-link" aria-label="Direct link to 美术有点难" title="Direct link to 美术有点难">​</a></h2>
<p>rt，美术对于我们这种理工来说还是有点难度的（）虽然也搞过一些设计与审美训练，但是实际上手还是会抓瞎</p>
<p>那就先找一个<strong>样板</strong>学学吧。于是最终成品是...</p>
<table><thead><tr><th>Where Are You From</th><th>Where Are You Go</th></tr></thead><tbody><tr><td><strong>Patrick&#x27;s Parabox (帕特里克的悖论箱)</strong></td><td>整体简约风格指导，箱子、地块设计、粒子效果等</td></tr><tr><td><strong>Baba is You</strong></td><td>角色设计、UI风格设计</td></tr><tr><td><strong>The Dance of Fire and Ice (冰与火之舞)</strong></td><td>编辑器界面设计</td></tr><tr><td>一拍脑袋想，没有参考的</td><td>组件动画设计</td></tr></tbody></table>
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;margin:20px 0"><p style="font-size:20px;color:white;margin-top:10px"></p><p><code>Patrick&#x27;s Parabox</code> 风格</p><p></p><img src="/img/docs/sokoban/par.jpg" alt="par" style="max-width:75%;height:auto;border-radius:10px"></div>
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;margin:20px 0"><p style="font-size:20px;color:white;margin-top:10px"></p><p><code>Baba is You</code> 风格</p><p></p><img src="/img/docs/sokoban/baba.jpg" alt="par" style="max-width:75%;height:auto;border-radius:10px"></div>
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;margin:20px 0"><p style="font-size:20px;color:white;margin-top:10px"></p><p><code>The Dance of Fire and Ice</code> 风格（编辑器）</p><p></p><img src="/img/docs/sokoban/adofai.png" alt="par" style="max-width:75%;height:auto;border-radius:10px"></div>
<p>虽然说美术风格上是个杂交作，但是除了背景音乐外的<strong>所有素材都是我们原创绘制的</strong>，工程文件也放在项目的根目录下了</p>
<p><strong>For Example 复选框动画的实现</strong></p>
<ol>
<li>首先通过 Photoshop 完成基础图层的绘制，并利用工具导出为 Json 格式</li>
</ol>
<p><img decoding="async" loading="lazy" alt="PS 绘制复选框" src="/assets/images/check-box-ps-e783b344124d78b02d08dfadfca12e17.png" width="2560" height="1379" class="img_ev3q"></p>
<ol start="2">
<li>通过 Spine 软件绘制复选框的动画，例如进入、退出、禁用等</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Spine 制作复选框动画" src="/assets/images/check-box-spine-3ffc2980361117064e9df00fff7d9b77.png" width="2560" height="1380" class="img_ev3q"></p>
<ol start="3">
<li>
<p>将素材导出，并用统一的素材加载类 <code>AssetsPathManager</code> 类导入项目中</p>
</li>
<li>
<p>使用素材创建组件</p>
</li>
</ol>
<p><img decoding="async" loading="lazy" alt="获取素材关键代码" src="/assets/images/assets-get-3e0e3ae569009a13133611f19cde7160.png" width="2280" height="900" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前端的逻辑难题">前端的逻辑难题<a href="#前端的逻辑难题" class="hash-link" aria-label="Direct link to 前端的逻辑难题" title="Direct link to 前端的逻辑难题">​</a></h2>
<p>其实前端开发并不是写一个 UI 就好了，因为组件之间会产生很多交互，所以依然需要注重一些逻辑。就比如...</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="游戏速度解耦-fps">游戏速度解耦 FPS<a href="#游戏速度解耦-fps" class="hash-link" aria-label="Direct link to 游戏速度解耦 FPS" title="Direct link to 游戏速度解耦 FPS">​</a></h3>
<p>这似乎是一个比较常见的话题，如果游戏中物体的移动速度关联到 FPS，有些性能太好的电脑快到飞起，有些性能太差的又慢到难受，这可不好</p>
<p>然而<strong>我在 30% 开发进度的时候才发现这个问题</strong>，没办法，只能推倒重构，被这些问题折磨了一两天：</p>
<ul>
<li>有些组件的动画更新是<strong>依照真实时间</strong>更新的，并不依赖于帧时间</li>
<li>要考虑极端波动的 FPS（例如掉帧），保证逻辑正确处理</li>
<li>考虑帧时间<strong>波动</strong>，需要每隔一段时间补上误差时间累积而成的帧，相应的内部逻辑<strong>不能发生重复处理</strong></li>
</ul>
<p>不简单，不简单（感叹）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="混杂的内部逻辑">混杂的内部逻辑<a href="#混杂的内部逻辑" class="hash-link" aria-label="Direct link to 混杂的内部逻辑" title="Direct link to 混杂的内部逻辑">​</a></h3>
<p>一开始的设想<strong>很美好</strong>，想着可以进行如下的分层结构：</p>
<ol>
<li><strong>显示层</strong> 负责组件的显示层面交互</li>
<li><strong>中间层</strong> 负责组件逻辑和内部逻辑的交互</li>
<li><strong>逻辑层</strong> 负责游戏逻辑的运行</li>
</ol>
<p>实际上编写了才发现：设想太美好，实际上可行性...</p>
<p>OK For example, 在设置界面的屏幕类 <code>SettingScene</code> 中有一个按钮 <code>Vsync</code>，表示是否开启垂直同步</p>
<p><img decoding="async" loading="lazy" alt="vsync setting" src="/assets/images/vsync-setting-39e2bef8ef15dfbcdf1b9140bf1b1444.png" width="426" height="286" class="img_ev3q"></p>
<p>当我们点击时，复选框将会改变状态（选中 &lt;-&gt; 未选中），同时引擎会传递给我们一个回调函数，表示点击事件的发生</p>
<p>问题来了：<strong>回调函数被调用时，复选框的状态是选中还是未选中？</strong></p>
<p>为了解决这个状态不一致的问题，我们写一个复选框类，回调函数与动画效果 都会在复选框类中被处理，而复选框类又会发起一个新的回调并传递选中状态，用户需要实现这个回调函数</p>
<p>现在我们的问题来到了实现复选框类的回调函数，我们希望设置更改后立刻检查差异，如果存在与原设置的差异，则显示保存按钮</p>
<p>检测设置文件是否相同的逻辑可以放到 <code>GameSetting</code> 的逻辑类中实现，然而想要获得当前的设置情况，就需要去查看其它组件的状态</p>
<p>然而，<strong>其它组件的类型较多</strong>，有复选框、选择器、滑块条等，如果每个组件发生变更都去读取这些组件的值，显得十分冗杂</p>
<p>所以也许需要定义一个 <code>onSettingChanged</code> 的方法，读取所有设置信息并进行比对</p>
<p>如果发现不一致，调用 <code>setSaveButtonVisiblility</code> 方法显示保存按钮</p>
<p>看上去比较美好，然而每次我们向设置界面增加设置组件的时候，都要做如下工作：</p>
<ol>
<li>在 <code>GameSetting</code> 类中增加对应的设置项</li>
<li>将组件类对象添加到设置界面中</li>
<li>在 <code>onSettingChanged</code> 方法中编写对应的读取逻辑</li>
</ol>
<p>...</p>
<p>十分繁琐，于是我们又要想，是不是可以写一个接口，统一为设置项配置组件、类信息与值信息？于是可以写一个 <code>SettingInterface</code> 接口，实现这个接口的设置类可以被自动注册到 <code>GameSetting</code> 以及被添加到设置界面中</p>
<p>对于各种不一致的设置类型（数值、选中等），实现一个适配器 <code>SettingAdapter</code>，可以将设置中的各种类型转化为统一的格式，方便 <code>Json</code> 实现序列化...</p>
<p><del>（已经开始各种设计模式了）</del></p>
<p><strong>TIP 以上设想大部分未实现，因为我只是完成 Java 作业罢了...</strong></p>
<p>由此可见其复杂...实际上，<strong>命令式</strong>的设计模式似 乎能够进一步促进这些逻辑的解耦，可以查找相关资料了解</p>
<p>最后再列一个前端的问题清单</p>
<table><thead><tr><th><strong>遇到的问题</strong></th><th><strong>是否解决</strong></th><th><strong>（预期）解决方案</strong></th></tr></thead><tbody><tr><td>单物体多动画同时执行，互相干扰产生非预期结果</td><td>✅</td><td>创建 <code>SingleActionInstanceManager</code> 管理器，如果有新动画创建，则立刻重置旧动画并执行新动画</td></tr><tr><td>需要一些滤镜，例如背景模糊</td><td>❌</td><td>我也不知道为什么 Shader 不起效果（惊恐）</td></tr><tr><td>LibGDX 的字体支持太简陋了，还有各种 bug</td><td>✅</td><td>把所有的字体画在位图上，用 <code>FontManager</code> 切割成单字，再用 <code>ImageFontStringObject</code> 拼合成文本组件</td></tr><tr><td>LibGDX 官方自带的物理引擎没弄明白...</td><td>✅</td><td>造轮子，包括加速度位移管理器 <code>AccelerationMovingManager</code> 和碰撞管理器 <code>OverlappingManager</code></td></tr><tr><td>我希望画面能跟着鼠标、人物...一起动</td><td>✅</td><td><code>MouseMovingTraceManager</code>，计算各种坐标变换，调整画面移动的幅度大小</td></tr><tr><td>不使用官方工具，我希望能简易地自定义粒子</td><td>✅</td><td><code>BackgroundGrayParticleManager</code> 等管理器，统一向屏幕对象添加粒子，并管理粒子生命周期</td></tr><tr><td>有一些组件是由多个其它组件组合而成，如何管理呢...</td><td>✅，但是❌</td><td>虽然开发了 <code>SokobanCombineObject</code>，然而算是一个失败的结构，不仅与 Actor 不兼容，开发组件时也诸多不便，只能咬牙硬忍</td></tr><tr><td>LibGDX 没有无 bug 的现成文本框控件（悲）</td><td>✅</td><td>写了一个 <code>InputTextField</code> 类，通过模拟光标、焦点、退格与输入等，捏了一个还算能看的文本框（然而只能输入英文）</td></tr><tr><td>Java Swing 的文件选择器丑爆了</td><td>✅</td><td>跨语言开发，调用系统 API 实现原生文件选择框调用，见下文</td></tr><tr><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>真心祝愿各位以后能够不碰上这些问题🙏</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="有点鸡肋的用户存档状态管理">有点鸡肋的...用户、存档状态管理<a href="#有点鸡肋的用户存档状态管理" class="hash-link" aria-label="Direct link to 有点鸡肋的...用户、存档状态管理" title="Direct link to 有点鸡肋的...用户、存档状态管理">​</a></h2>
<p><del>单机游戏用不着用户管理吧（吐槽）</del></p>
<p>因为项目要求，所以做了用户管理和存档管理。设计的时候采用了<strong>存档附属于用户</strong>的方式，单用户单文件</p>
<p>非常<strong>多此一举</strong>且莫名其妙（笑）地为存档做了加密</p>
<p>加密方案也非常简单，用户名+固定字串，AES 加密，附加标志 ENC 后储存，而提取则反之</p>
<p>而存档方面，每个用户被分配了三个存档，储存了地图的记录、游玩情况等，如果解析错误会在用户登录时抛出</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="似乎不算很难的逻辑工程">似乎不算很难的逻辑工程<a href="#似乎不算很难的逻辑工程" class="hash-link" aria-label="Direct link to 似乎不算很难的逻辑工程" title="Direct link to 似乎不算很难的逻辑工程">​</a></h2>
<p>这里要感谢 <a href="https://github.com/StiCK-bot" target="_blank" rel="noopener noreferrer">StiCK-bot</a> 完成了推箱子的<strong>初代逻辑</strong>，我在其基础上做了一些改进。具体来说...</p>
<ul>
<li>通过递归判断箱子是否可以被推动（本作设计为可连推多个箱子）</li>
<li>计算每个物体的位移，将位移信息聚合为命令，发送到前端</li>
<li>前端解析位移命令，转化成动 画显示</li>
</ul>
<p>这样就能操控人物进行游戏了</p>
<p>接下来是各种附加の逻辑</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="死锁检测">死锁检测<a href="#死锁检测" class="hash-link" aria-label="Direct link to 死锁检测" title="Direct link to 死锁检测">​</a></h3>
<p>项目 bonus 要求对游戏进行死锁检测，发现死锁则判定游戏失败，给出提示或重置</p>
<p>然而死锁是个很复杂的问题（）具体可以看看我的几篇 blog</p>
<p>👉 <a href="/blog/2024/12/04/Sokoban-Corner-Deadlock-Test">推箱子死锁检测</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ai-求解器">AI 求解器<a href="#ai-求解器" class="hash-link" aria-label="Direct link to AI 求解器" title="Direct link to AI 求解器">​</a></h3>
<p>严格来说不能算 AI，因为求解器使用的都是传统算法 (IDA*) 等，并且由于我稀烂的算法能力（雾）导致它运行起来老牛拖车</p>
<p><del>唉，能用就行吧</del></p>
<p>另外有一些关于 <code>IDA*</code> 算法的改进思路，不过，<strong>还没有进行实验</strong>，且当一个笑谈</p>
<p>👉 <a href="/blog/2024/12/07/IDAStar-New-Algo-Thinking">IDA* 改进随想</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="跨语言开发">跨语言开发<a href="#跨语言开发" class="hash-link" aria-label="Direct link to 跨语言开发" title="Direct link to 跨语言开发">​</a></h2>
<p>这里属实是为了一碗醋包了一桌饺，本意大概就是在 Java 中调用系统 API 调用文件选择框...</p>
<p>项目选择了 JNI 作为 Java 的外部交互接口，与 C++ 编译的 dll 进行交互</p>
<p>C++ 部分的代码中，通过调用 <code>GetSaveFileName</code> 系统 API 打开文件对话框，获取到保存文件路径后返回 Java 中</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">JNIEXPORT jstring JNICALL </span><span class="token function" style="color:rgb(80, 250, 123)">Java_com_sokoban_utils_WindowsFileChooser_saveFileChooser</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">JNIEnv</span><span class="token operator">*</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> jclass cls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> jstring filterString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    OPENFILENAMEW ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">wchar_t</span><span class="token plain"> szFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">260</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> L</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;NewMap.map&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Initialize OPENFILENAMEW structure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">ZeroMemory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token plain">ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lStructSize </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrFile </span><span class="token operator">=</span><span class="token plain"> szFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> L</span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">nMaxFile </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">szFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">wchar_t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 从 Java 获取 UTF-8 编码的过滤字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">char</span><span class="token operator">*</span><span class="token plain"> filterCStr </span><span class="token operator">=</span><span class="token plain"> env</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">GetStringUTFChars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filterString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">nullptr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 转换为宽字符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    size_t filterLen </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">strlen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filterCStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    size_t wideCharLen </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">MultiByteToWideChar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CP_UTF8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> filterCStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">NULL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">wstring </span><span class="token function" style="color:rgb(80, 250, 123)">filterWStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">wideCharLen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> L</span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">MultiByteToWideChar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CP_UTF8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> filterCStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">filterWStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> wideCharLen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 替换分隔符 &#x27;|&#x27; 为 null 字符 &#x27;\0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">auto</span><span class="token operator">&amp;</span><span class="token plain"> ch </span><span class="token operator">:</span><span class="token plain"> filterWStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ch </span><span class="token operator">==</span><span class="token plain"> L</span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;|&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ch </span><span class="token operator">=</span><span class="token plain"> L</span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 释放 Java 字符串资源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    env</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">ReleaseStringUTFChars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filterString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> filterCStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 设置过滤器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrFilter </span><span class="token operator">=</span><span class="token plain"> filterWStr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">c_str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">nFilterIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrFileTitle </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">NULL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">nMaxFileTitle </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrInitialDir </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">NULL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 设置保存对话框特定的标志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Flags </span><span class="token operator">=</span><span class="token plain"> OFN_PATHMUSTEXIST </span><span class="token operator">|</span><span class="token plain"> OFN_OVERWRITEPROMPT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Display the Save dialog box</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">GetSaveFileName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token plain">ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 文件已选择，返回文件路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> env</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">NewString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> jchar</span><span class="token operator">*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">wcslen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ofn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lpstrFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 没有选择文件，返回 null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">NULL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>大概就这样...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="编辑器以及它的内存泄露">编辑器，以及它的内存泄露<a href="#编辑器以及它的内存泄露" class="hash-link" aria-label="Direct link to 编辑器，以及它的内存泄露" title="Direct link to 编辑器，以及它的内存泄露">​</a></h2>
<p>我们给游戏增加了一个编辑器页面，可以用这个编辑器绘制地图，具体的操作也比较简单：</p>
<ol>
<li>左键<strong>放置</strong>当前物体，中键<strong>删除</strong>对应物体，右键<strong>拖动</strong>画布，滚轮<strong>缩放</strong>画布</li>
<li>下方菜单栏可以选择 3 类物体：<strong>实体物体</strong>（箱子、玩家等）、<strong>目标物体</strong>（玩家和箱子的目标点）、<strong>装饰物体</strong>（不同颜色的背景）</li>
<li>上方菜单栏可以进行基本文件操作</li>
<li>左侧有两个小按钮，本来打算做子地图功能的，后来发现一团糟，最终没有实现</li>
</ol>
<p>开发阶段比较头疼的有两个问题...</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="组件顺序怎么调">组件顺序怎么调？<a href="#组件顺序怎么调" class="hash-link" aria-label="Direct link to 组件顺序怎么调？" title="Direct link to 组件顺序怎么调？">​</a></h3>
<p>组件的显示顺序还是非常重要的，毕竟三类物体的显示顺序是：<strong>实体最上，目标为中，装饰为底</strong></p>
<p>然而组件可不会这么听话，如果不按着顺序添加到 <code>stage</code> 中，就会显示错乱</p>
<p>前面提到了 <code>LibGDX</code> 的 <code>setZIndex</code> 方法就是摆设，没法对组件位置进行调整，于是所有的组件位置只能通过手动 <code>remove</code> 再手动 <code>addActor</code> 贴到最前面</p>
<p>实在头疼，最后决定当用户执行任何按键操作时，都进行一次重绘，按照顺序的重绘</p>
<p>然而这也为内存泄漏<strong>埋下了祸根</strong>...</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="坐标转换不会算">坐标转换不会算...<a href="#坐标转换不会算" class="hash-link" aria-label="Direct link to 坐标转换不会算..." title="Direct link to 坐标转换不会算...">​</a></h3>
<p>是的， 与大多数游戏引擎一样，<code>LibGDX</code> 中有几套坐标，例如...</p>
<table><thead><tr><th>坐标类型</th><th>干啥用的</th></tr></thead><tbody><tr><td>屏幕坐标</td><td>从屏幕的左上角开始为原点，到右下角的像素坐标</td></tr><tr><td>窗口坐标</td><td>与屏幕，不过原点处于窗口左上角</td></tr><tr><td>世界坐标（摄像机坐标）</td><td>游戏中存在一个被称为 <code>ViewPort</code> 的视图转换器，可以将屏幕坐标线性映射为给定矩形中的相对坐标，左下角为原点</td></tr><tr><td>GL 坐标</td><td>...</td></tr></tbody></table>
<p>如果仅仅是转换，其实用两个自带的函数就好了，然而，在编辑器中，我们还需要<strong>移动、缩放 ViewPort 的摄像机</strong></p>
<p>怎么办呢？缩放相对好说，只需要在<strong>滚轮事件被触发</strong>的时候，给 <code>ViewPort</code> 一个缩放即可</p>
<p>拖动就麻烦了，假定鼠标右键被按下的时候，游戏传入了一个事件，参数含有鼠标的屏幕坐标 <code>screenX</code> <code>screenY</code></p>
<p>接着用户发生了拖动！在新的一帧，新的鼠标坐标被传入： <code>screenX&#x27;</code> <code>screenY&#x27;</code></p>
<p>是时候将屏幕坐标转换成世界坐标了，通过 <code>ViewPort</code> 提供的转换函数 <code>unPack</code>，我们获得了世界坐标 <code>world</code></p>
<p>那么接下来应该移动 <code>ViewPort</code> 的摄像机，从而让画面移动了，我们计算鼠标移动的世界坐标差 <code>Δworld</code>，让摄像机进行位移</p>
<blockquote>
<p><em>一切都看着如此美好，直到第二帧</em></p>
</blockquote>
<p>理论上，如果从第二帧开始鼠标静止，这一帧的世界坐标差 <code>Δworld</code> 为 0，摄像机也不会位移吧？</p>
<p><strong>No.</strong> 由于上一帧中，摄像机与我们的鼠标发生了相同的位移，从而 <code>unPack</code> 后，我们的 <code>screenX</code> <code>screenY</code> 实际上<strong>等于最开始一帧的 <code>screenX</code> <code>screenY</code>，而非最开始一帧的 <code>screenX&#x27;</code> <code>screenY&#x27;</code></strong></p>
<p>...god, 这不是我喜欢的推导...</p>
<p>最终调试出来一个是是而非的拖动逻辑了结（按住拖动后画面会一直运动，速度与鼠标相对位移相关）</p>
<blockquote>
<p>只能说，如果有思路，还请指教...</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="内存泄露查不出">内存泄露查不出！<a href="#内存泄露查不出" class="hash-link" aria-label="Direct link to 内存泄露查不出！" title="Direct link to 内存泄露查不出！">​</a></h3>
<p>这个简直是<strong>地狱难度</strong>的排查 o(TヘTo)</p>
<p>刚才在组件绘制顺序那一栏提到</p>
<blockquote>
<p>...当用户执行任何按键操作时，都进行一次重绘，按照顺序的重绘...</p>
</blockquote>
<p>没错，这个逻辑，导致了内存的大量泄漏...</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="起因">起因<a href="#起因" class="hash-link" aria-label="Direct link to 起因" title="Direct link to 起因">​</a></h4>
<p>那天我用编辑器画几个地图，但是我总感觉越画越卡，到后面几乎快画不出来</p>
<p>我认为可能是有什么东西在吃我的性能，于是我打开任务管理器查看</p>
<p>一看吓一跳：我的游戏有<strong>高达 20G 的内存占用</strong>，只是因为机器的内存是 64G，没有立即崩溃，所以没发现这个问题</p>
<p><del>什么谷歌浏览器开发者</del></p>
<p>那我只能着手排查一下了...</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="排查">排查<a href="#排查" class="hash-link" aria-label="Direct link to 排查" title="Direct link to 排查">​</a></h4>
<p>首先要<strong>复现</strong>泄露问题</p>
<p>很快可以发现，即使什么操作都不做，只是在画布上按住鼠标左键，内存就会不停地泄露</p>
<p>说明了 啥？<strong>泄露与用户可见的显示无关，可能是在重绘的时候未能让 GC 处理掉老的组件对象，造成这些对象数据在内存中累积</strong></p>
<p>看了一眼代码，并没有发现很明显的错误，只好上工具了，唉...</p>
<p>排查内存泄漏是有比较好用的工具的，这里我选用 <code>VisualVM</code> 对内存进行分析。</p>
<ol>
<li>首先先让游戏进入内存泄露的状态，此时它的对象被储存在堆中，用命令将 JVM 虚拟机中的数据转换为<strong>堆转储文件</strong></li>
<li>用 <code>VisualVM</code> 打开堆转储文件，开始分析占用内存最多的对象</li>
</ol>
<p>在分析中发现，箱子对象产生了<strong>大量异常的引用</strong>，达到了数万次，而画面中的箱子对象又比较多，导致内存不停地增长</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="退而求其次的修复">退而求其次的修复<a href="#退而求其次的修复" class="hash-link" aria-label="Direct link to 退而求其次的修复" title="Direct link to 退而求其次的修复">​</a></h4>
<p>一开始我尝试从根源解决这个问题，于是我加了很多代码试图在更新的时候销毁原对象，包括显式的 <code>remove</code>、通知 GC 来进行回收等，然而这些都没有丝毫效果，这些箱子对象的引用似乎仍然被一些 <code>LibGDX</code> 的内部对象牢牢把持</p>
<p>实在没法，最后我只能将画面更新方式修改为<strong>懒更新</strong>，只有发生实际的物件更新才会尝试重新生成画面，把内存泄露控制在可控范围</p>
<p><em>如果有 debug 大神，欢迎挑战...</em></p>
<p>（到这里编辑器基本就结束了）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p>没啥好总结了，下次做项目（如果还有），<strong>能用就行</strong>😡</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/program">program</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/LifeCheckpoint/LifeCheckpoint.github.io/tree/main/docs/computer_science/projects/sokoban/index.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/computer_science/projects/manimgeo/utils/geo_mathe"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">GeoMathe</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/computer_science/mathematica/mma-mind-graph"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">思维导图绘制</div></a></nav></div><div style="margin-top:20px"></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#开发准备" class="table-of-contents__link toc-highlight">开发准备</a><ul><li><a href="#-为什么选择-libgdx" class="table-of-contents__link toc-highlight">✅ 为什么选择 LibGDX？</a></li><li><a href="#-为什么别用-libgdx" class="table-of-contents__link toc-highlight">❌ 为什么别用 LibGDX？</a></li></ul></li><li><a href="#项 目特色" class="table-of-contents__link toc-highlight">项目“特色”</a></li><li><a href="#美术有点难" class="table-of-contents__link toc-highlight">美术有点难</a></li><li><a href="#前端的逻辑难题" class="table-of-contents__link toc-highlight">前端的逻辑难题</a><ul><li><a href="#游戏速度解耦-fps" class="table-of-contents__link toc-highlight">游戏速度解耦 FPS</a></li><li><a href="#混杂的内部逻辑" class="table-of-contents__link toc-highlight">混杂的内部逻辑</a></li></ul></li><li><a href="#有点鸡肋的用户存档状态管理" class="table-of-contents__link toc-highlight">有点鸡肋的...用户、存档状态管理</a></li><li><a href="#似乎不算很难的逻辑工程" class="table-of-contents__link toc-highlight">似乎不算很难的逻辑工程</a><ul><li><a href="#死锁检测" class="table-of-contents__link toc-highlight">死锁检测</a></li><li><a href="#ai-求解器" class="table-of-contents__link toc-highlight">AI 求解器</a></li></ul></li><li><a href="#跨语言开发" class="table-of-contents__link toc-highlight">跨语言开发</a></li><li><a href="#编辑器以及它的内存泄露" class="table-of-contents__link toc-highlight">编辑器，以及它的内存泄露</a><ul><li><a href="#组件顺序怎么调" class="table-of-contents__link toc-highlight">组件顺序怎么调？</a></li><li><a href="#坐标转换不会算" class="table-of-contents__link toc-highlight">坐标转换不会算...</a></li><li><a href="#内存泄露查不出" class="table-of-contents__link toc-highlight">内存泄露查不出！</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>